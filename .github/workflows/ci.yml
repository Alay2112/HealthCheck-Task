name: CI Pipeline

on:
  push:
    branches:
    - main
  pull_request:
    branches: 
    - main

jobs:

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
       - name: checking codes
         uses: actions/checkout@v4

       - name: python backend
         uses: actions/setup-python@v5
         with:
           python-version: "3.13.1"
        
       - name: Installing backend dependencies
         working-directory: backend
         run: |
           python -m pip install --upgrade pip
           pip install -r requirements.txt
           pip install flake8

       - name: runing lint for backend
         working-directory: backend
         run: flake8 .


       - name: react frontend
         uses: actions/setup-node@v4
         with:
           node-version: "20"

       - name: Installing frontend dependancies
         working-directory: frontend
         run: npm install

       - name: run lint for frontend
         working-directory: frontend
         run: npm run lint


  build:
     name: BACKEND-FRONTEND Build
     runs-on: ubuntu-latest
     needs: lint

     steps:
       - name: checking codes
         uses: actions/checkout@v4

       - name: python backend
         uses: actions/setup-python@v5
         with:
           python-version: "3.13.1"
        
       - name: Installing backend dependencies
         working-directory: backend
         run: |
           python -m pip install --upgrade pip
           pip install -r requirements.txt

       - name: react frontend
         uses: actions/setup-node@v4
         with:
           node-version: "20"

       - name: Installing frontend dependancies
         working-directory: frontend
         run: npm install

       - name: Build frontend
         working-directory: frontend
         run: npm run build


  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
        - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test -d test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_HOST: localhost
      DB_NAME: test
      DB_USER: test
      DB_PASSWORD: test
      DB_PORT: 5432

    steps:
      - name: checking code
        uses: actions/checkout@v4
      
      - name: python backend
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.1"

      - name: Installing backend dependancies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: running test
        working-directory: backend
        run: |
          python -m pytest -q

  docker:
    name: docker build and version strategy
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: checking code
        uses: actions/checkout@v4

      - name: postgres's .env
        run: |
          echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
          echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env

      - name: backend's .env
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> backend/.env
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> backend/.env
          echo "DB_USER=${{ secrets.DB_USER }}" >> backend/.env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> backend/.env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> backend/.env

      - name: frontend's .env
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >>frontend/.env


      - name: check docker compose file
        run: docker compose config

      - name: build docker compose file
        run: docker compose build

      - name: tagging the images
        run: |

          short_sha=$(echo "$GITHUB_SHA" | cut -c1-7)

          BACKEND_IMG="backend-img"
          FRONTEND_IMG="frontend-img"

          docker tag ${BACKEND_IMG}:latest ${BACKEND_IMG}:${short_sha}
          docker tag ${BACKEND_IMG}:latest ${BACKEND_IMG}:v1.0.${{github.run_number}} 
          docker tag ${FRONTEND_IMG}:latest ${FRONTEND_IMG}:${short_sha} 
          docker tag ${FRONTEND_IMG}:latest ${FRONTEND_IMG}:v1.0.${{github.run_number}} 
          
      - name: Listing docker images
        run: docker images

    
